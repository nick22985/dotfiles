#!/usr/bin/env bash


source "$DOTFILES_DIR/lib/utils.sh"

parse_args "$@"

log "Setting up Hyprland..."

if ! command_exists Hyprland; then
    log_warn "Hyprland is not installed. Run the 'packages' script first."
    exit 1
fi

if command_exists pacman; then
    log_info "Checking Hyprland dependencies..."
    hypr_packages=(
        "hyprpaper"
        "hypridle"
        "hyprlock"
				"xdg-desktop-portal-gtk"
        "xdg-desktop-portal-hyprland"
        "waybar"
        "rofi-wayland"
        "swaync"
        "grim"
        "slurp"
        "wl-clipboard"
        "xorg-xhost"
        "zenity"            # GUI dialogs (for waybar-hotspot)
        "libnotify"         # Desktop notifications (for waybar-hotspot)
				"hyprpolkitagent"
				# dark theme support
				"adw-gtk-theme"
				"qt5ct"
				"qt6ct"
				"kvantum"
				"kvantum"
				"breeze-icons"
    )

    packages_to_install=()
    for package in "${hypr_packages[@]}"; do
        if ! is_installed_pacman "$package"; then
            packages_to_install+=("$package")
        else
            log_success "$package already installed"
        fi
    done

    if [ ${#packages_to_install[@]} -gt 0 ]; then
        log_info "Installing Hyprland dependencies: ${packages_to_install[*]}"
        if [[ $DRY_RUN == "0" ]]; then
            sudo pacman -S --needed --noconfirm "${packages_to_install[@]}" || log_warn "Some Hyprland packages may have failed to install"
        fi
    else
        log_success "All Hyprland dependencies already installed"
    fi
elif command_exists apt; then
    log_info "Hyprland dependencies for Debian/Ubuntu not fully supported"
    log_info "Please install manually: waybar, rofi, grim, slurp, wl-clipboard"
fi

if [[ -d "$HOME/.config/hypr/scripts" ]]; then
    log_info "Making Hyprland scripts executable..."
    if [[ $DRY_RUN == "0" ]]; then
        find "$HOME/.config/hypr/scripts" -type f -exec chmod +x {} \;
    fi
    log_success "Hyprland scripts are executable"
else
    log_info "Hyprland scripts directory not found (will be available after running 'dotfiles')"
fi

if [[ -d "$HOME/.config/waybar/scripts" ]]; then
    log_info "Making waybar scripts executable..."
    if [[ $DRY_RUN == "0" ]]; then
        find "$HOME/.config/waybar/scripts" -type f -exec chmod +x {} \;
    fi
    log_success "Waybar scripts are executable"
else
    log_info "Waybar scripts directory not found (will be available after running 'dotfiles')"
fi

if [[ -d "$HOME/.config/rofi/scripts" ]]; then
    log_info "Making rofi scripts executable..."
    if [[ $DRY_RUN == "0" ]]; then
        find "$HOME/.config/rofi/scripts" -type f -exec chmod +x {} \;
    fi
    log_success "Rofi scripts are executable"
else
    log_info "Rofi scripts directory not found (will be available after running 'dotfiles')"
fi

log_success "Hyprland setup complete"
