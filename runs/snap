#!/usr/bin/env bash


script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export DOTFILES_DIR="${DOTFILES_DIR:-$script_dir}"

source "$DOTFILES_DIR/lib/utils.sh"

parse_args "$@"

log "Installing Snap applications..."

if ! command_exists snap; then
    log_warn "Snap not available. Install it first with the packages script."
    exit 1
fi

if command_exists pacman; then
    log_info "Setting up Snap for Arch Linux..."

    if [[ $DRY_RUN == "0" ]]; then
        if [[ ! -e /snap ]]; then
            log_info "Creating /snap symlink..."
            sudo ln -sf /var/lib/snapd/snap /snap || log_warn "Failed to create /snap symlink"
        fi

        log_info "Enabling snapd services..."
        sudo systemctl enable --now snapd.socket || log_warn "Failed to enable snapd.socket"

        if systemctl is-active --quiet apparmor 2>/dev/null; then
            log_info "AppArmor is active, configuring for snap..."
            sudo systemctl restart apparmor.service || log_warn "Failed to restart apparmor"
            sudo systemctl restart snapd.service || log_warn "Failed to restart snapd"
            sudo systemctl enable --now snapd.apparmor.service || log_warn "Failed to enable snapd.apparmor"
        else
            log_info "AppArmor not active, starting snapd without AppArmor..."
            sudo systemctl restart snapd.service || log_warn "Failed to restart snapd"
        fi

        log_info "Waiting for snapd to be ready..."
        sleep 3

        if snap version >/dev/null 2>&1; then
            log_success "Snap is ready"
        else
            log_warn "Snap may not be fully ready, continuing anyway..."
        fi
    else
        log "Would setup snap symlink and services"
    fi
fi

log_info "Installing Snap applications..."
snap_packages=(
    # Add snap packages here as needed
    # Example: "discord"
    # Example: "code --classic"
)

# Install Snap packages using utility function
if [ ${#snap_packages[@]} -gt 0 ]; then
    install_packages_snap "${snap_packages[@]}"
else
    log_info "No Snap packages configured for installation"
fi

log_success "Snap setup complete"
