#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
LOCAL_HYPR="$HOME/.config/hypr"
DOTFILES_HYPR="$DOTFILES_DIR/env/.config/hypr"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if local hypr config exists
if [[ ! -d "$LOCAL_HYPR" ]]; then
    log_error "Local hypr config not found at $LOCAL_HYPR"
    exit 1
fi

# Check if dotfiles hypr config exists
if [[ ! -d "$DOTFILES_HYPR" ]]; then
    log_error "Dotfiles hypr config not found at $DOTFILES_HYPR"
    exit 1
fi

log_info "Syncing hypr config from $LOCAL_HYPR to $DOTFILES_HYPR"

# Create backup of current dotfiles hypr config
BACKUP_DIR="$DOTFILES_DIR/.backup/hypr-$(date +%Y%m%d-%H%M%S)"
log_info "Creating backup at $BACKUP_DIR"
mkdir -p "$(dirname "$BACKUP_DIR")"
cp -r "$DOTFILES_HYPR" "$BACKUP_DIR"

# Sync the configs - using rsync to preserve structure and handle deletions
log_info "Syncing configuration files..."
rsync -av --delete \
    --exclude='*.log' \
    --exclude='*.tmp' \
    --exclude='.cache/' \
    "$LOCAL_HYPR/" "$DOTFILES_HYPR/"

# Check for potential sensitive files
SENSITIVE_PATTERNS=("*password*" "*secret*" "*token*" "*key*" "*private*")
for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if find "$DOTFILES_HYPR" -iname "$pattern" -type f | grep -q .; then
        log_warn "Found potential sensitive files matching pattern: $pattern"
        find "$DOTFILES_HYPR" -iname "$pattern" -type f
        echo "Please review these files before committing."
    fi
done

# Show git status
cd "$DOTFILES_DIR"
if git status --porcelain | grep -q "env/.config/hypr"; then
    log_info "Changes detected in hypr config:"
    git status env/.config/hypr
    
    echo
    read -p "Review changes with git diff? [y/N]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git diff env/.config/hypr
    fi
else
    log_info "No changes detected in hypr config"
fi

log_info "Sync completed successfully!"
log_info "Backup available at: $BACKUP_DIR"